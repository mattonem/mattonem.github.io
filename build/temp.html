<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Fiches Personnages</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom animation for pulsing elements */
        @keyframes pulse-intense {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }
        .animate-pulse-intense {
            animation: pulse-intense 1.5s infinite;
        }
        /* Hide scrollbar for textarea */
        textarea::-webkit-scrollbar {
            display: none;
        }
        textarea {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen flex flex-col items-center p-4 md:p-8">
        
        <!-- Modals Container -->
        <div id="modals-container"></div>

        <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-xl w-full max-w-7xl">
            <h2 class="text-3xl font-bold mb-6 text-center text-purple-400">Gestionnaire de Fiche Personnage</h2>

            <!-- Character Creation Section (Visible by default) -->
            <div id="character-creation-section">
                <!-- Content will be injected by JavaScript -->
            </div>

            <!-- Character Sheet Section (Hidden by default) -->
            <div id="character-sheet-section" class="hidden">
                 <!-- Content will be injected by JavaScript -->
            </div>

            <!-- Save/Load Section -->
            <div id="save-load-section" class="p-4 sm:p-6 bg-gray-700 rounded-xl shadow-inner mt-8">
                <h3 class="text-2xl font-semibold mb-4 text-purple-300">Sauvegarde et Chargement</h3>
                <div class="flex flex-col gap-4">
                    <button id="save-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">G√©n√©rer un code de sauvegarde</button>
                    <div id="save-code-container" class="relative hidden">
                        <textarea readonly id="save-code-output" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 focus:ring focus:ring-purple-500 resize-none h-24" placeholder="Votre code de sauvegarde appara√Ætra ici"></textarea>
                        <button id="copy-code-button" class="absolute top-2 right-2 bg-purple-500 hover:bg-purple-600 text-white text-xs px-2 py-1 rounded-md">Copier</button>
                    </div>
                    <div>
                        <label for="saveCodeInput" class="block text-gray-300 font-medium mb-1">Coller un code pour charger</label>
                        <div class="flex gap-2">
                            <input type="text" id="saveCodeInput" class="flex-1 bg-gray-800 text-white border border-gray-600 rounded-lg p-2 focus:ring focus:ring-purple-500" placeholder="Collez le code ici...">
                            <button id="load-button" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">Charger</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- Wait for the DOM to be fully loaded before running the script ---
    document.addEventListener('DOMContentLoaded', () => {

        // --- STATE MANAGEMENT ---
        // A single object to hold the entire state of the application, similar to React's state.
        const state = {
            character: null,
            diceResult: null,
            fractureModalOpen: false,
            notesModalOpen: false,
            newCharacter: {
                name: '', race: 'humain',
                stats: { FOR: 0, RES: 0, CHA: 0, SAV: 0, DEX: 0, PER: 0 },
                pv: 5, pt: 0, pe: 0, bastos: 1000, pp: 0,
                inventory: [], skeletonType: 'biologique', cybernetics: [],
                activeStatus: 'ok', fractureLocation: '', notes: '',
            }
        };

        // --- CONSTANTS & DATA ---
        const statEmojis = { FOR: 'üí™', RES: 'üõ°Ô∏è', CHA: 'üí¨', SAV: 'üìö', DEX: 'üëã', PER: 'üëÅÔ∏è' };
        const skeletonOptions = {
            biologique: { name: "Biologique", slots: 0, ability: "Aucune modification cybern√©tique disponible." },
            eco: { name: "Squelette ECO+", slots: 1, ability: "1 Slot par membre." },
            serie: { name: "Squelette de Serie", slots: 2, ability: "2 Slots par membre." },
            arkanic: { name: "Squelette Arkanic", slots: 2, ability: "2 Slots + Sauvegarde du sortil√®ge au niveau auquel il est grav√©." },
            spartan: { name: "Squelette Spartan", slots: 2, ability: "2 Slots + Immunit√© aux fractures ü¶¥." },
            pnp: { name: "Squelette Plug'n'Play", slots: 1, ability: "1 Slot + Peut installer n'importe quel MODs sans aide." },
            gold: { name: "Squelette Gold Rush", slots: 3, ability: "3 Slots par membre." },
        };
        const statusEffects = {
            ok: { emoji: 'üòÄ', name: 'TOUT VA BIEN', description: "Vous n'√™tes affect√© par aucun effet." },
            burn: { emoji: 'üî•', name: 'BR√õLURES', description: "Perte de 1 PV par tour." },
            bleed: { emoji: 'ü©∏', name: 'SAIGNEMENTS', description: "Chaque action co√ªte 1 PV." },
            stun: { emoji: 'üí´', name: '√âTOURDISSEMENT', description: "Inerte pour la dur√©e de la crise." },
            fracture: { emoji: 'ü¶¥', name: 'FRACTURE', description: "FOR, DEX, RES ou PER / 2 selon la localisation." },
            hypoesthesia: { emoji: 'üßø', name: 'HYPOESTH√âSIE', description: "PER / 2, perte possible d'autres sens." },
            pasTop: { emoji: 'üí¶', name: 'PAS TOP TOP', description: "Seuil de r√©ussite de toutes les actions maluss√© de 1 (ex: 8+ devient 9+)." },
            snare: { emoji: 'üîó', name: 'ENTRAVE', description: "Ne peut plus se d√©placer mais peut toujours agir." },
            sick: { emoji: 'üí©', name: 'MALADE', description: "Test de RES avant chaque action pour ne pas passer son tour." },
            frenzy: { emoji: 'üí¢', name: 'FR√âN√âSIE', description: "Ne diff√©rencie plus alli√©s et ennemis." },
        };
        const raceAbilities = {
            humain: { name: "Dividendes", description: "50‚Çø par üé≤ [CHA] toutes les 4h ou par partie." },
            troll: { name: "R√©sistance Naturelle", description: "R√©sistance x2 lors d'un test contre toxines, poisons, radiations, etc." },
            elfe: { name: "Organis√©", description: "+2 PCüì¶ suppl√©mentaires." },
            demon: { name: "Savoir Ancestral", description: "-1 PTüåÄ lors de l'utilisation de la magie." },
            droide: { name: "Peau de Fer", description: "+1 PPüíú permanent." },
            trifide: { name: "Photosynth√®se", description: "Soin total (peut faire repousser les membres) 1 fois par partie." },
        };
        const statColors = {
            FOR: 'bg-red-900/50 border-red-700', RES: 'bg-orange-900/50 border-orange-700', CHA: 'bg-yellow-900/50 border-yellow-700',
            SAV: 'bg-blue-900/50 border-blue-700', DEX: 'bg-green-900/50 border-green-700', PER: 'bg-pink-900/50 border-pink-700',
            default: 'bg-gray-800/50 border-gray-600'
        };

        // --- DOM ELEMENT REFERENCES ---
        const creationSection = document.getElementById('character-creation-section');
        const sheetSection = document.getElementById('character-sheet-section');
        const modalsContainer = document.getElementById('modals-container');
        const saveButton = document.getElementById('save-button');
        const loadButton = document.getElementById('load-button');
        const copyCodeButton = document.getElementById('copy-code-button');
        const saveCodeContainer = document.getElementById('save-code-container');
        const saveCodeOutput = document.getElementById('save-code-output');
        const saveCodeInput = document.getElementById('saveCodeInput');

        // --- LOGIC & HELPER FUNCTIONS ---
        
        /**
         * Calculates derived stats like PV, PA, PC based on base stats and effects.
         * @param {object} char - The character object.
         * @returns {object} An object with all calculated stats.
         */
        const calculateDerivedStats = (char) => {
            if (!char) return {};
            const ptReduction = Math.floor(char.pt / 10);
            let reducedStats = {
                FOR: Math.max(0, char.stats.FOR - ptReduction), RES: Math.max(0, char.stats.RES - ptReduction),
                CHA: Math.max(0, char.stats.CHA - ptReduction), SAV: Math.max(0, char.stats.SAV - ptReduction),
                DEX: Math.max(0, char.stats.DEX - ptReduction), PER: Math.max(0, char.stats.PER - ptReduction),
            };

            if (char.activeStatus === 'hypoesthesia') { reducedStats.PER = Math.ceil(reducedStats.PER / 2); }
            if (char.activeStatus === 'fracture' && char.fractureLocation) {
                const loc = char.fractureLocation;
                if (loc.includes('Jambe')) { reducedStats.FOR = Math.ceil(reducedStats.FOR / 2); }
                if (loc.includes('Bras')) { reducedStats.DEX = Math.ceil(reducedStats.DEX / 2); }
                if (loc === 'Torse') { reducedStats.RES = Math.ceil(reducedStats.RES / 2); }
                if (loc === 'T√™te') { reducedStats.PER = Math.ceil(reducedStats.PER / 2); }
            }

            const inventoryBonus = char.inventory.reduce((acc, item) => { acc.pc += Number(item.weight) || 0; acc.pp += Number(item.armorPoints) || 0; return acc; }, { pc: 0, pp: 0 });
            const baseRacePP = char.race === 'droide' ? 1 : 0;
            const raceBonusPC = char.race === 'elfe' ? 2 : 0;
            const pc = (reducedStats.FOR + 3) + inventoryBonus.pc + raceBonusPC;
            const pvMax = reducedStats.RES + 5;
            const pa = Math.max(1, Math.ceil(reducedStats.DEX / 3));
            const totalPp = baseRacePP + inventoryBonus.pp;
            return { pc, pvMax, pa, totalPp, reducedStats };
        };
        
        /**
         * Shows a custom alert modal. Replaces the native browser alert().
         * @param {string} message - The message to display.
         */
        const showAlert = (message) => {
            const alertModalHTML = `
                <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4">
                  <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full border border-yellow-500">
                    <h3 class="text-xl font-bold mb-4 text-yellow-300 text-center">Notification</h3>
                    <p class="text-center text-white mb-6">${message}</p>
                    <button id="alert-close-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">OK</button>
                  </div>
                </div>
            `;
            modalsContainer.innerHTML = alertModalHTML;
            document.getElementById('alert-close-button').addEventListener('click', () => {
                modalsContainer.innerHTML = '';
            });
        };

        // --- RENDER FUNCTIONS ---
        // These functions are responsible for updating the DOM. They read from the `state` object.

        /**
         * Main render function. Decides whether to show the creation form or the character sheet.
         */
        const render = () => {
            if (state.character) {
                creationSection.classList.add('hidden');
                sheetSection.classList.remove('hidden');
                renderCharacterSheet();
            } else {
                creationSection.classList.remove('hidden');
                sheetSection.classList.add('hidden');
                renderCreationForm();
            }
            renderModals();
        };

        /**
         * Renders all active modals based on the state.
         */
        const renderModals = () => {
            let modalHTML = '';
            if (state.diceResult) {
                const { rolls, successes, threshold, statName } = state.diceResult;
                const rollSpans = rolls.map(roll => {
                    let colorClass = 'bg-gray-600';
                    if (roll === 10) colorClass = 'bg-yellow-500 text-black animate-pulse';
                    else if (roll >= threshold) colorClass = 'bg-green-500';
                    else if (roll === 1) colorClass = 'bg-red-500';
                    return `<span class="w-12 h-12 flex items-center justify-center text-xl font-bold rounded-lg ${colorClass}">${roll}</span>`;
                }).join('');

                modalHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4">
                      <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-md w-full border border-purple-500">
                        <h3 class="text-2xl font-bold mb-4 text-purple-300 text-center">${statName ? `Jet de ${statName}` : 'R√©sultat du Jet'}</h3>
                        <p class="text-center mb-4">Seuil de r√©ussite : ${threshold}+</p>
                        <div class="flex flex-wrap justify-center gap-3 mb-4">${rollSpans}</div>
                        <p class="text-center text-xl font-bold mb-6">üèÜ Succ√®s Total : <span class="text-green-400">${successes}</span></p>
                        <button id="close-dice-modal" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Fermer</button>
                      </div>
                    </div>`;
            } else if (state.fractureModalOpen) {
                 const bodyParts = ['T√™te', 'Torse', 'Bras G', 'Bras D', 'Jambe G', 'Jambe D'];
                 const partButtons = bodyParts.map(part => `<button data-location="${part}" class="fracture-part-button bg-gray-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg transition-colors">${part}</button>`).join('');
                 modalHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4">
                      <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-sm w-full border border-red-500">
                        <h3 class="text-2xl font-bold mb-4 text-red-300 text-center">ü¶¥ O√π est la fracture ?</h3>
                        <div class="grid grid-cols-2 gap-4">${partButtons}</div>
                        <button id="close-fracture-modal" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Annuler</button>
                      </div>
                    </div>`;
            } else if (state.notesModalOpen) {
                const charLimit = 5000;
                modalHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4">
                      <div class="bg-gray-800 p-6 rounded-2xl shadow-xl max-w-2xl w-full border border-purple-500 flex flex-col">
                        <h3 class="text-2xl font-bold mb-4 text-purple-300 text-center">üìã Prise de Notes</h3>
                        <textarea id="notes-textarea" maxlength="${charLimit}" class="w-full h-64 bg-gray-900 text-white border border-gray-600 rounded-lg p-2 focus:ring-1 focus:ring-purple-500 resize-none" placeholder="√âcrivez vos notes ici...">${state.character.notes}</textarea>
                        <div id="notes-char-count" class="text-right text-sm text-gray-400 mt-1">${state.character.notes.length} / ${charLimit}</div>
                        <div class="flex gap-4 mt-4">
                          <button id="close-notes-modal" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Fermer</button>
                          <button id="save-notes-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Sauvegarder</button>
                        </div>
                      </div>
                    </div>`;
            }
            modalsContainer.innerHTML = modalHTML;
            addModalEventListeners();
        };
        
        /**
         * Renders the character creation form.
         */
        const renderCreationForm = () => {
            const { pvMax, totalPp } = calculateDerivedStats(state.newCharacter);
            const statsInputs = Object.keys(state.newCharacter.stats).map(stat => `
                <div key="${stat}">
                    <label class="block text-gray-300 text-sm font-bold text-center mb-1">${stat}${statEmojis[stat]}</label>
                    <input type="number" data-stat="${stat}" value="${state.newCharacter.stats[stat]}" class="new-char-stat-input w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-center focus:ring-1 focus:ring-purple-500" min="0"/>
                </div>
            `).join('');
            const raceOptions = Object.keys(raceAbilities).map(raceKey => `<option value="${raceKey}" class="capitalize" ${state.newCharacter.race === raceKey ? 'selected' : ''}>${raceKey}</option>`).join('');

            creationSection.innerHTML = `
                <div class="mb-8 p-4 sm:p-6 bg-gray-700 rounded-xl shadow-inner">
                    <h3 class="text-2xl font-semibold mb-4 text-purple-300">Cr√©er un nouveau personnage</h3>
                    <form id="creation-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="new-char-name" class="block text-gray-300 font-medium mb-1">Nom</label><input type="text" id="new-char-name" value="${state.newCharacter.name}" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 focus:ring-1 focus:ring-purple-500" placeholder="Ex: John Doe" required /></div>
                        <div><label for="new-char-race" class="block text-gray-300 font-medium mb-1">Race</label><select id="new-char-race" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 focus:ring-1 focus:ring-purple-500">${raceOptions}</select></div>
                        <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-3">${statsInputs}</div>
                        <div class="md:col-span-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 text-center">
                            <div><label class="block text-sm text-gray-300 mb-1">PV ‚ù§Ô∏è</label><span id="new-char-pv" class="block w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 font-bold">${pvMax}</span></div>
                            <div><label class="block text-sm text-gray-300 mb-1">PP üíú</label><span class="block w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 font-bold">${totalPp || 0}</span></div>
                            <div><label class="block text-sm text-gray-300 mb-1">PT üåÄ</label><input type="number" id="new-char-pt" value="${state.newCharacter.pt}" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-center focus:ring-1 focus:ring-purple-500" min="0"/></div>
                            <div><label class="block text-sm text-gray-300 mb-1">PE üß†</label><input type="number" id="new-char-pe" value="${state.newCharacter.pe}" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-center focus:ring-1 focus:ring-purple-500" min="0"/></div>
                            <div><label class="block text-sm text-gray-300 mb-1">Bastos ‚Çø</label><input type="number" id="new-char-bastos" value="${state.newCharacter.bastos}" class="w-full bg-gray-800 text-white border border-gray-600 rounded-lg p-2 text-center focus:ring-1 focus:ring-purple-500" min="0"/></div>
                        </div>
                        <div class="md:col-span-2"><button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-md">Cr√©er le personnage</button></div>
                    </form>
                </div>
            `;
            addCreationFormEventListeners();
        };

        /**
         * Renders the full character sheet with all details, inventory, and cybernetics.
         */
        const renderCharacterSheet = () => {
            const char = state.character;
            const { pc, pvMax, pa, totalPp, reducedStats } = calculateDerivedStats(char);
            const isPvLow = char.pv <= 4 && pvMax > 0;
            const pvPercent = pvMax > 0 ? (char.pv / pvMax) * 100 : 0;
            const selectedSkeleton = skeletonOptions[char.skeletonType];
            
            let malusStats = {};
            if (char.activeStatus === 'hypoesthesia') { malusStats.PER = true; } 
            else if (char.activeStatus === 'fracture' && char.fractureLocation) {
                const loc = char.fractureLocation;
                if (loc.includes('Jambe')) malusStats.FOR = true;
                if (loc.includes('Bras')) malusStats.DEX = true;
                if (loc === 'Torse') malusStats.RES = true;
                if (loc === 'T√™te') malusStats.PER = true;
            }

            const statsHTML = Object.entries(char.stats).map(([stat, value]) => `
                <div class="text-center">
                    <label class="block text-gray-300 text-sm font-bold">${stat}${statEmojis[stat]}</label>
                    <div class="relative mt-1 flex items-center gap-1">
                        <input type="number" data-stat="${stat}" value="${value}" class="char-stat-input w-full bg-gray-900/50 text-white border border-gray-600 rounded-lg p-1 text-center focus:ring-1 focus:ring-purple-500" min="0"/>
                        <button data-stat="${stat}" class="stat-roll-button bg-green-600 hover:bg-green-700 rounded-full w-6 h-6 text-xs font-bold flex-shrink-0">USE!</button>
                        ${Math.floor(char.pt / 10) > 0 ? `<span class="absolute -top-2 -left-2 text-xs bg-purple-600 text-white rounded-full px-1.5 py-0.5 z-10">-${Math.floor(char.pt / 10)}</span>` : ''}
                        ${malusStats[stat] ? `<span class="absolute -top-2 right-5 text-xs bg-red-600 text-white rounded-full px-1.5 py-0.5 z-10">/2</span>` : ''}
                    </div>
                </div>
            `).join('');

            const statusOptionsHTML = Object.entries(statusEffects).map(([key, { emoji, name }]) => `<option value="${key}" ${char.activeStatus === key ? 'selected' : ''}>${emoji} ${name}</option>`).join('');
            
            const inventoryHTML = char.inventory.map(item => {
                const isWeapon = item.stat && typeof item.diceBonus === 'number' && typeof item.successThreshold === 'number';
                const statValue = reducedStats[item.stat] || 0;
                const colorClass = statColors[item.stat] || statColors.default;
                return `
                    <div data-item-id="${item.id}" class="item-card p-3 rounded-lg border relative ${colorClass}">
                        <button class="delete-item-button absolute top-1 right-1 text-gray-400 hover:text-white text-xl leading-none">&times;</button>
                        <div class="flex justify-between items-start gap-2">
                            <input type="text" data-field="name" value="${item.name}" class="item-input bg-transparent font-bold text-lg w-full"/>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <select data-field="stat" class="item-input bg-gray-600 rounded p-1 text-xs">
                                    <option value="" ${!item.stat ? 'selected' : ''}>-</option>
                                    ${Object.keys(statEmojis).map(s => `<option value="${s}" ${item.stat === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                                <span class="font-bold text-purple-300 text-xs">${item.stat ? `${statValue}+${item.diceBonus}` : ''}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-2 text-center my-2">
                            <div><label class="block text-xs">üé≤</label><input type="number" data-field="diceBonus" value="${item.diceBonus}" class="item-input bg-gray-600 rounded p-1 w-full text-center text-sm"/></div>
                            <div><label class="block text-xs">üèÜ</label><input type="number" data-field="successThreshold" value="${item.successThreshold}" class="item-input bg-gray-600 rounded p-1 w-full text-center text-sm"/></div>
                            <div><label class="block text-xs">üì¶</label><input type="number" data-field="weight" value="${item.weight}" class="item-input bg-gray-600 rounded p-1 w-full text-center text-sm"/></div>
                            <div><label class="block text-xs">üíú</label><input type="number" data-field="armorPoints" value="${item.armorPoints}" class="item-input bg-gray-600 rounded p-1 w-full text-center text-sm"/></div>
                            <div class="flex flex-col items-center"><label class="block text-xs">üí•</label><input type="text" data-field="bastosCost" value="${item.bastosCost}" class="item-input bg-gray-600 rounded p-1 w-full text-center text-sm"/></div>
                        </div>
                        ${isWeapon ? `<button class="attack-button bg-red-600 hover:bg-red-700 rounded-full px-4 py-1 text-xs font-bold w-full mb-2">FEU!</button>` : ''}
                        <textarea data-field="specialAbility" class="item-input bg-gray-900/50 rounded p-1 w-full text-xs h-16 resize-none" placeholder="Capacit√©...">${item.specialAbility}</textarea>
                    </div>
                `;
            }).join('');

            const cyberneticsHTML = char.cybernetics.map(c => {
                const colorClass = c.type === 'mutation' ? 'bg-purple-900/50 border-purple-700' : 'bg-gray-600/50 border-gray-500';
                return `
                    <div data-cyber-id="${c.id}" class="cyber-card p-3 rounded-lg border relative ${colorClass}">
                        <button class="delete-cyber-button absolute top-1 right-1 text-gray-400 hover:text-white text-xl leading-none">&times;</button>
                        <input type="text" data-field="name" value="${c.name}" class="cyber-input bg-transparent font-bold text-lg w-full mb-2"/>
                        <div class="flex gap-2 mb-2">
                            <select data-field="bodyPart" class="cyber-input bg-gray-600 rounded p-1 w-full text-xs">
                                ${['T√™te', 'Torse', 'Bras G', 'Bras D', 'Jambe G', 'Jambe D'].map(p => `<option ${c.bodyPart === p ? 'selected' : ''}>${p}</option>`).join('')}
                            </select>
                            <select data-field="type" class="cyber-input bg-gray-600 rounded p-1 w-full text-xs">
                                <option value="cybernetic" ${c.type === 'cybernetic' ? 'selected' : ''}>ü¶æ Cybern√©tique</option>
                                <option value="mutation" ${c.type === 'mutation' ? 'selected' : ''}>ü¶† Mutation</option>
                            </select>
                        </div>
                        <textarea data-field="ability" class="cyber-input bg-gray-900/50 rounded p-1 w-full text-xs h-16 resize-none" placeholder="Capacit√©...">${c.ability}</textarea>
                    </div>
                `;
            }).join('');

            const skeletonOptionsHTML = Object.entries(skeletonOptions).map(([key, { name }]) => `<option value="${key}" ${char.skeletonType === key ? 'selected' : ''}>${name}</option>`).join('');

            sheetSection.innerHTML = `
                <div class="mb-8">
                    <div class="bg-gray-700 p-4 rounded-2xl shadow-lg border border-gray-600">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="flex flex-col gap-4">
                                <!-- Cadre Identit√© -->
                                <div class="bg-gray-800 p-4 rounded-lg flex flex-col gap-4">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="text-2xl font-bold text-purple-400">${char.name}</h4>
                                            <p class="text-md text-gray-400 capitalize">Race: <span class="font-semibold">${char.race}</span></p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button id="open-notes-button" class="bg-green-600 hover:bg-green-700 text-white font-bold w-10 h-10 rounded-lg flex items-center justify-center text-xl transition-colors">üìã</button>
                                            <button id="delete-character-button" class="text-red-400 hover:text-red-600 font-bold text-2xl leading-none p-1">&times;</button>
                                        </div>
                                    </div>
                                    <div class="bg-gray-900/50 p-2 rounded-lg text-center"><p class="text-purple-300 font-bold text-sm">${raceAbilities[char.race].name}</p><p class="text-xs text-gray-300">${raceAbilities[char.race].description}</p></div>
                                    <div>
                                        <div class="flex justify-between items-center text-sm font-semibold mb-1"><span>PV‚ù§Ô∏è : ${char.pv} / ${pvMax}</span><div class="flex gap-1"><button id="pv-minus" class="bg-red-500 hover:bg-red-600 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center text-sm transition-colors">-</button><button id="pv-plus" class="bg-green-500 hover:bg-green-600 text-white font-bold w-6 h-6 rounded-full flex items-center justify-center text-sm transition-colors">+</button></div></div>
                                        <div class="w-full bg-gray-600 rounded-full h-2.5 relative overflow-hidden"><div class="h-2.5 rounded-full transition-all duration-300 ${isPvLow ? 'bg-red-500 animate-pulse' : 'bg-green-500'}" style="width: ${pvPercent}%"></div></div>
                                    </div>
                                </div>

                                <!-- Cadre STATISTIQUES -->
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <h5 class="text-xl font-semibold text-purple-300 mb-2 text-center">STATISTIQUES</h5>
                                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">${statsHTML}</div>
                                </div>
                                
                                <!-- Cadre ATTRIBUTS & √âTAT -->
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <h5 class="text-xl font-semibold text-purple-300 mb-2 text-center">ATTRIBUTS & √âTAT</h5>
                                    <div class="grid grid-cols-3 gap-2 text-center">
                                        <div><label class="block text-sm text-gray-300">PCüì¶</label><span class="block w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm font-bold">${pc}</span></div>
                                        <div><label class="block text-sm text-gray-300">PAü¶∂</label><span class="block w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm font-bold">${pa}</span></div>
                                        <div><label class="block text-sm text-gray-300">PPüíú</label><span class="block w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm font-bold">${totalPp}</span></div>
                                        <div><label class="block text-sm text-gray-300">PTüåÄ</label><input type="number" id="char-pt" value="${char.pt}" class="char-attribute-input w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm focus:ring-1 focus:ring-purple-500" min="0"/></div>
                                        <div><label class="block text-sm text-gray-300">PEüß†</label><input type="number" id="char-pe" value="${char.pe}" class="char-attribute-input w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm focus:ring-1 focus:ring-purple-500 ${char.pe >= 10 ? 'animate-pulse-intense bg-yellow-400 text-black' : ''}" min="0"/></div>
                                        <div><label class="block text-sm text-gray-300">Bastos‚Çø</label><input type="number" id="char-bastos" value="${char.bastos}" class="char-attribute-input w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-center text-sm focus:ring-1 focus:ring-purple-500" min="0"/></div>
                                    </div>
                                    <div class="mt-4">
                                        <label class="block text-sm text-gray-300 mb-1 text-center">Effet Actif</label>
                                        <select id="char-status" class="char-attribute-input w-full bg-gray-900/50 border border-gray-600 rounded-lg p-1 text-sm focus:ring-1 focus:ring-purple-500">${statusOptionsHTML}</select>
                                        <p class="text-xs text-gray-400 mt-1 italic text-center">${statusEffects[char.activeStatus]?.description}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2 space-y-4">
                                <div>
                                    <h5 class="text-xl font-semibold text-purple-300 mb-2">Inventaire</h5>
                                    <div id="inventory-list" class="grid grid-cols-1 gap-4">${inventoryHTML}</div>
                                    <button id="add-item-button" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-4 rounded-lg transition-colors text-sm">+ Ajouter un objet</button>
                                </div>
                                <div>
                                    <h5 class="text-xl font-semibold text-purple-300 mb-2">Cybern√©tique & Mutations</h5>
                                    <div class="bg-gray-800 p-2 rounded-lg mb-2">
                                        <select id="char-skeleton" class="char-attribute-input w-full bg-gray-600 rounded p-1 mb-1">${skeletonOptionsHTML}</select>
                                        <p class="text-xs text-center text-purple-200">${selectedSkeleton.ability}</p>
                                    </div>
                                    <div id="cybernetics-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">${cyberneticsHTML}</div>
                                    <button id="add-cyber-button" class="mt-2 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-4 rounded-lg transition-colors text-sm">+ Ajouter une modification</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            addCharacterSheetEventListeners();
        };

        // --- EVENT LISTENER ATTACHMENT FUNCTIONS ---
        
        const addCreationFormEventListeners = () => {
            document.getElementById('creation-form').addEventListener('submit', handleAddCharacter);
            document.getElementById('new-char-name').addEventListener('input', e => { state.newCharacter.name = e.target.value; });
            document.getElementById('new-char-race').addEventListener('change', e => { state.newCharacter.race = e.target.value; renderCreationForm(); });
            document.getElementById('new-char-pt').addEventListener('input', e => { state.newCharacter.pt = parseInt(e.target.value) || 0; });
            document.getElementById('new-char-pe').addEventListener('input', e => { state.newCharacter.pe = parseInt(e.target.value) || 0; });
            document.getElementById('new-char-bastos').addEventListener('input', e => { state.newCharacter.bastos = parseInt(e.target.value) || 0; });
            document.querySelectorAll('.new-char-stat-input').forEach(input => {
                input.addEventListener('input', e => {
                    const stat = e.target.dataset.stat;
                    state.newCharacter.stats[stat] = parseInt(e.target.value) || 0;
                    const { pvMax } = calculateDerivedStats(state.newCharacter);
                    document.getElementById('new-char-pv').textContent = pvMax;
                });
            });
        };

        const addCharacterSheetEventListeners = () => {
            document.getElementById('delete-character-button').addEventListener('click', handleDeleteCharacter);
            document.getElementById('pv-plus').addEventListener('click', () => handlePvChange(1));
            document.getElementById('pv-minus').addEventListener('click', () => handlePvChange(-1));
            document.getElementById('open-notes-button').addEventListener('click', () => { state.notesModalOpen = true; render(); });
            document.getElementById('add-item-button').addEventListener('click', handleAddItem);
            document.getElementById('add-cyber-button').addEventListener('click', handleAddCybernetic);

            document.querySelectorAll('.char-stat-input').forEach(input => {
                input.addEventListener('input', e => handleStatChange(e.target.dataset.stat, e.target.value));
            });
            document.querySelectorAll('.stat-roll-button').forEach(button => {
                button.addEventListener('click', e => handleStatRoll(e.target.dataset.stat));
            });
            
            // Event delegation for dynamic lists
            const sheet = document.getElementById('character-sheet-section');
            sheet.addEventListener('click', e => {
                if (e.target.classList.contains('delete-item-button')) {
                    handleDeleteItem(e.target.closest('.item-card').dataset.itemId);
                }
                if (e.target.classList.contains('attack-button')) {
                    const itemId = e.target.closest('.item-card').dataset.itemId;
                    const item = state.character.inventory.find(i => i.id == itemId);
                    handleAttack(item);
                }
                if (e.target.classList.contains('delete-cyber-button')) {
                    handleDeleteCybernetic(e.target.closest('.cyber-card').dataset.cyberId);
                }
            });

            sheet.addEventListener('input', e => {
                if (e.target.classList.contains('item-input')) {
                    const card = e.target.closest('.item-card');
                    handleItemChange(card.dataset.itemId, e.target.dataset.field, e.target.value);
                }
                if (e.target.classList.contains('cyber-input')) {
                    const card = e.target.closest('.cyber-card');
                    handleCyberneticChange(card.dataset.cyberId, e.target.dataset.field, e.target.value);
                }
                if (e.target.classList.contains('char-attribute-input')) {
                    const attribute = e.target.id.replace('char-', '');
                    handleAttributeChange(attribute, e.target.value);
                }
            });
             sheet.addEventListener('change', e => { // For select elements
                if (e.target.classList.contains('item-input') || e.target.classList.contains('cyber-input') || e.target.classList.contains('char-attribute-input')) {
                    const attribute = e.target.id ? e.target.id.replace('char-', '') : e.target.dataset.field;
                    const value = e.target.value;
                    if (e.target.closest('.item-card')) {
                        handleItemChange(e.target.closest('.item-card').dataset.itemId, attribute, value);
                    } else if (e.target.closest('.cyber-card')) {
                         handleCyberneticChange(e.target.closest('.cyber-card').dataset.cyberId, attribute, value);
                    } else {
                        handleAttributeChange(attribute, value);
                    }
                }
            });
        };

        const addModalEventListeners = () => {
            const closeDice = document.getElementById('close-dice-modal');
            if (closeDice) closeDice.addEventListener('click', () => { state.diceResult = null; render(); });

            const closeFracture = document.getElementById('close-fracture-modal');
            if(closeFracture) closeFracture.addEventListener('click', () => { state.fractureModalOpen = false; render(); });
            document.querySelectorAll('.fracture-part-button').forEach(button => {
                button.addEventListener('click', e => handleFractureLocationSelect(e.target.dataset.location));
            });

            const closeNotes = document.getElementById('close-notes-modal');
            if(closeNotes) closeNotes.addEventListener('click', () => { state.notesModalOpen = false; render(); });
            const saveNotes = document.getElementById('save-notes-button');
            if(saveNotes) saveNotes.addEventListener('click', () => {
                const content = document.getElementById('notes-textarea').value;
                handleSaveNotes(content);
            });
            const notesTextarea = document.getElementById('notes-textarea');
            if(notesTextarea) {
                notesTextarea.addEventListener('input', e => {
                    document.getElementById('notes-char-count').textContent = `${e.target.value.length} / 5000`;
                });
            }
        };

        // --- EVENT HANDLER FUNCTIONS ---

        const handleAddCharacter = (e) => {
            e.preventDefault();
            if (state.newCharacter.name.trim() === '') return;
            const { pvMax } = calculateDerivedStats(state.newCharacter);
            state.character = { ...state.newCharacter, id: Date.now(), pv: pvMax };
            render();
        };

        const handleDeleteCharacter = () => {
            state.character = null;
            render();
        };

        const handleStatChange = (stat, value) => {
            state.character.stats[stat] = parseInt(value) || 0;
            const { pvMax } = calculateDerivedStats(state.character);
            if (state.character.pv > pvMax) {
                state.character.pv = pvMax;
            }
            renderCharacterSheet();
        };

        const handlePvChange = (delta) => {
            const { pvMax } = calculateDerivedStats(state.character);
            state.character.pv = Math.min(pvMax, Math.max(0, state.character.pv + delta));
            renderCharacterSheet();
        };

        const handleAttributeChange = (attribute, value) => {
            if (['pt', 'pe', 'bastos'].includes(attribute)) {
                value = parseInt(value) || 0;
            }
            state.character[attribute] = value;
            if (attribute === 'activeStatus' && value === 'fracture') {
                state.fractureModalOpen = true;
                render();
            } else if (attribute === 'activeStatus') {
                state.character.fractureLocation = '';
                renderCharacterSheet();
            } else {
                renderCharacterSheet();
            }
        };

        const handleFractureLocationSelect = (location) => {
            state.character.fractureLocation = location;
            state.fractureModalOpen = false;
            render();
        };

        const handleAddItem = () => {
            const newItem = { id: Date.now(), name: 'Nouvel objet', stat: '', diceBonus: 0, successThreshold: 8, weight: 0, armorPoints: 0, bastosCost: '-', specialAbility: '' };
            state.character.inventory.push(newItem);
            renderCharacterSheet();
        };
        const handleDeleteItem = (itemId) => {
            state.character.inventory = state.character.inventory.filter(item => item.id != itemId);
            renderCharacterSheet();
        };
        const handleItemChange = (itemId, field, value) => {
            const item = state.character.inventory.find(i => i.id == itemId);
            if (!item) return;
            const numericFields = ['diceBonus', 'successThreshold', 'weight', 'armorPoints'];
            if (numericFields.includes(field)) {
                value = parseInt(value, 10);
                if (isNaN(value)) value = 0;
            }
            item[field] = value;
            renderCharacterSheet(); // Re-render to update dependent values like stat bonus display
        };

        const handleAddCybernetic = () => {
            const newCyber = { id: Date.now(), name: 'Nouvelle mod.', bodyPart: 'T√™te', type: 'cybernetic', ability: '' };
            state.character.cybernetics.push(newCyber);
            renderCharacterSheet();
        };
        const handleDeleteCybernetic = (cyberId) => {
            state.character.cybernetics = state.character.cybernetics.filter(c => c.id != cyberId);
            renderCharacterSheet();
        };
        const handleCyberneticChange = (cyberId, field, value) => {
            const cyber = state.character.cybernetics.find(c => c.id == cyberId);
            if (cyber) cyber[field] = value;
            renderCharacterSheet();
        };

        const handleAttack = (item) => {
            let { reducedStats } = calculateDerivedStats(state.character);
            let successThreshold = Number(item.successThreshold);
            if (state.character.activeStatus === 'pasTop') successThreshold += 1;
            const statValue = reducedStats[item.stat] || 0;
            const diceCount = statValue + (Number(item.diceBonus) || 0);
            if (diceCount <= 0) { showAlert("Nombre de d√©s insuffisant pour attaquer !"); return; }
            if (!isNaN(item.bastosCost) && item.bastosCost !== '-') {
                const cost = Number(item.bastosCost);
                if (state.character.bastos < cost) { showAlert("Pas assez de Bastos !"); return; }
                state.character.bastos -= cost;
            }
            const rolls = Array.from({ length: diceCount }, () => Math.floor(Math.random() * 10) + 1);
            const successes = rolls.filter(r => r >= successThreshold).length;
            state.diceResult = { rolls, successes, threshold: successThreshold };
            render();
        };

        const handleStatRoll = (statName) => {
            const { reducedStats } = calculateDerivedStats(state.character);
            const diceCount = reducedStats[statName];
            if (diceCount <= 0) { showAlert("Statistique trop basse pour lancer les d√©s !"); return; }
            let threshold = 8;
            if (state.character.activeStatus === 'pasTop') threshold += 1;
            const rolls = Array.from({ length: diceCount }, () => Math.floor(Math.random() * 10) + 1);
            const successes = rolls.filter(r => r >= threshold).length;
            state.diceResult = { rolls, successes, threshold, statName };
            render();
        };

        const handleSaveNotes = (content) => {
            state.character.notes = content;
            state.notesModalOpen = false;
            render();
        };

        const handleSave = () => {
            if (!state.character) { showAlert("Aucun personnage √† sauvegarder !"); return; }
            const stateToSave = { character: state.character };
            try {
                const jsonString = JSON.stringify(stateToSave);
                const saveCode = btoa(unescape(encodeURIComponent(jsonString)));
                saveCodeOutput.value = saveCode;
                saveCodeContainer.classList.remove('hidden');
            } catch (e) {
                console.error("Error saving character:", e);
                showAlert("Une erreur est survenue lors de la sauvegarde.");
            }
        };

        const handleLoad = () => {
            const code = saveCodeInput.value;
            if (!code) return;
            try {
                const decodedString = decodeURIComponent(escape(atob(code)));
                const loadedState = JSON.parse(decodedString);
                if (loadedState.character) {
                    state.character = loadedState.character;
                    saveCodeInput.value = '';
                    saveCodeContainer.classList.add('hidden');
                    render();
                } else {
                    showAlert('Le code de sauvegarde ne contient pas de personnage valide.');
                }
            } catch (e) {
                console.error('Invalid save code.', e);
                showAlert('Le code de sauvegarde est invalide ou corrompu.');
            }
        };

        const handleCopy = () => {
            saveCodeOutput.select();
            saveCodeOutput.setSelectionRange(0, 99999); // For mobile devices
            try {
                document.execCommand('copy');
                showAlert('Code copi√© dans le presse-papiers !');
            } catch (err) {
                showAlert('Erreur lors de la copie du code.');
            }
        };

        // --- INITIALIZATION ---
        saveButton.addEventListener('click', handleSave);
        loadButton.addEventListener('click', handleLoad);
        copyCodeButton.addEventListener('click', handleCopy);
        
        // Initial render of the application
        render();
    });
    </script>
</body>
</html>
